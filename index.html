<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像一括ダウンロード</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f7f9; }
        .container { max-width: 900px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* 入力フォームのスタイル */
        .input-area { display: flex; margin-bottom: 25px; gap: 10px; }
        #imageUrl { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn-add { padding: 12px 20px; background-color: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        .btn-add:hover { background-color: #229954; }

        /* ダウンロードボタンのスタイル */
        .btn-download-all { padding: 15px 30px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 20px; width: 100%; transition: background-color 0.3s; }
        .btn-download-all:hover { background-color: #2980b9; }
        .btn-download-all:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* 画像リストのスタイル (Grid) */
        #imageList { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 10px; 
        }
        .image-item { 
            border: none;
            padding: 0; 
            margin-bottom: 0; 
            position: relative; 
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0; 
            text-align: center; 
            overflow: hidden; 
            border-radius: 4px; 
        }
        
        /* 削除アイコンのCSS */
        .image-item::after {
            content: "×"; 
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.9); 
            color: white;
            font-size: 16px;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 50%; 
            cursor: pointer;
            z-index: 20;
            transition: background 0.2s;
        }
        .image-item:hover::after {
            background: #c0392b;
        }

        /* 画像をアスペクト比を維持して表示するためのコンテナ */
        .image-preview-container {
            width: 100%;
            height: auto; 
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-bottom: 0; 
            padding: 5px 0; 
        }
        .image-item img { 
            display: block; 
            border: none;
            border-radius: 0;
            width: auto; 
            height: auto; 
            max-width: 95%; 
            object-fit: contain; 
        }
        
        /* 画像の上に重ねるファイル名/番号のスタイル */
        .image-info { 
            position: absolute; 
            top: 5px;
            left: 5px;
            padding: 3px 6px;
            background-color: rgba(0, 0, 0, 0.6); 
            color: white; 
            border-radius: 3px;
            z-index: 10; 
            font-size: 12px;
            font-weight: bold;
            max-width: 80%; 
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .note { margin-top: 25px; padding: 15px; border: 1px solid #f39c12; background-color: #fffbe6; color: #e67e22; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>画像一括ダウンロード</h1>
    
    <p>ダウンロードしたい画像URLを入力し画像を追加ボタンを押してください</p>

    <div class="input-area">
        <input type="text" id="imageUrl" placeholder="画像のURLを入力してください (例: https://...)">
        <button class="btn-add" id="addButton">画像を追加</button>
    </div>

    <ul id="imageList">
        </ul>
    
    <button class="btn-download-all" id="downloadAllButton" disabled>リストの画像を全てダウンロード</button>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageUrlInput = document.getElementById('imageUrl');
    const addButton = document.getElementById('addButton');
    const imageList = document.getElementById('imageList');
    const downloadAllButton = document.getElementById('downloadAllButton');
    const imageCount = document.getElementById('count');
    
    const urls = [];

    // URLを正規化（プロトコルを補完）する関数
    function normalizeUrl(inputUrl) {
        let url = inputUrl.trim();
        
        if (url.length < 5) return null; 

        if (url.startsWith('data:')) {
            return url;
        }

        if (url.startsWith('http://') || url.startsWith('https://')) {
            return url;
        } 
        
        if (url.startsWith('//')) {
            return 'https:' + url;
        }
        
        try {
            const testUrl = new URL('https://' + url); 
            return 'https://' + url;
        } catch (e) {
             return null;
        }
    }

    // URLからファイル名部分を推測する関数
    function getFileName(url) {
        if (url.startsWith('data:')) {
            const mimeTypeMatch = url.match(/^data:image\/([^;]+)/);
            const type = mimeTypeMatch ? mimeTypeMatch[1] : '不明';
            return `data:形式 (${type})`;
        }
        
        try {
            const urlObject = new URL(url);
            const path = urlObject.pathname;
            const filename = path.substring(path.lastIndexOf('/') + 1);
            
            if (filename.length > 0 && filename.includes('.')) {
                return filename;
            } else {
                return urlObject.hostname.replace('www.', '') + '...';
            }
        } catch (e) {
            return `URLが無効`;
        }
    }

    // URLを追加する関数
    function addImage() {
        const rawUrl = imageUrlInput.value;
        const url = normalizeUrl(rawUrl);

        if (!url) {
            alert('有効な画像URLを入力してください。');
            return;
        }

        if (urls.includes(url)) {
            alert('このURLは既に追加されています。');
            return;
        }
        
        urls.push(url);
        renderList();
        imageUrlInput.value = ''; 
        imageUrlInput.focus();
    }
    
    // リストを描画する関数
    function renderList() {
        imageList.innerHTML = ''; 
        
        urls.forEach((url, index) => {
            const listItem = document.createElement('li');
            listItem.className = 'image-item';
            listItem.setAttribute('data-url', url);

            // ×アイコンがクリックされたら削除を実行
            listItem.onclick = function(e) {
                const rect = listItem.getBoundingClientRect();
                const iconArea = {
                    x1: rect.right - 30,
                    y1: rect.top,
                    x2: rect.right,
                    y2: rect.top + 30
                };
                
                if (e.clientX >= iconArea.x1 && e.clientX <= iconArea.x2 && 
                    e.clientY >= iconArea.y1 && e.clientY <= iconArea.y2) {
                    removeImage(url);
                    e.stopPropagation(); 
                }
            };


            // プレビューコンテナ
            const previewContainer = document.createElement('div');
            previewContainer.className = 'image-preview-container';

            // プレビュー画像
            const img = document.createElement('img');
            img.src = url;
            img.alt = '画像プレビュー';
            
            // 画像の読み込み失敗時の処理
            img.onerror = function() {
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiByeD0iNCIgZmlsbD0iI0REQURERCIvPgo8cGF0aCBkPSJNMTIgMTdMMTcgMTJMMTQgOUw1IDE4TDUgMTdIOC41TDEyIDE3WiIgc3Ryb2tlPSIjNzc3Nzc3IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSI5LjUiIGN5PSI5LjUiIHI9IjEuNSIgZmlsbD0iIzc3Nzc3NyIvPgo8L2F2Zz4='; 
            };
            
            previewContainer.appendChild(img);

            // 情報 (画像の上に重ねる)
            const infoDiv = document.createElement('div');
            infoDiv.className = 'image-info';
            const fileName = getFileName(url);
            
            // ファイル名を表示
            infoDiv.innerHTML = `<strong>${index + 1}.</strong> ${fileName}`; 

            listItem.appendChild(previewContainer);
            listItem.appendChild(infoDiv); 
            imageList.appendChild(listItem);
        });
        
        // カウントとダウンロードボタンの状態を更新
        imageCount.textContent = urls.length;
        downloadAllButton.disabled = urls.length === 0;
    }

    // URLをリストから削除する関数
    function removeImage(urlToRemove) {
        const index = urls.indexOf(urlToRemove);
        if (index > -1) {
            urls.splice(index, 1);
            renderList();
        }
    }

    /**
     * 連番を指定された桁数で文字列化する関数
     * @param {number} number 連番 (1, 2, 3...)
     * @param {number} totalDigits 指定された桁数 (1, 2, 3...)
     * @returns {string} ゼロパディングされた連番文字列
     */
    function getSequenceString(number, totalDigits) {
        if (totalDigits <= 1) {
            // #が1つ、またはそれ以下の場合、パディングなし
            return number.toString();
        }
        
        // 2桁以上のパディングが必要な場合
        return number.toString().padStart(totalDigits, '0');
    }


    // 全てダウンロードする関数
    function downloadAllImages() {
        if (urls.length === 0) {
            alert('ダウンロードする画像がリストにありません。');
            return;
        }
        
        // 1. プロンプトで連番パターンを取得
        let pattern = prompt("ダウンロードファイル名のパターンを入力してください。\n連番を入れたい場所に「#」を桁数分入力してください。", "photo-##");

        if (pattern === null) {
            return;
        }
        
        let usePattern = pattern.trim();
        
        // 正規表現で連続した # の塊（#+）を一つだけ見つける
        const placeholderMatch = usePattern.match(/(#+)/);
        
        let placeholder = null;
        let totalDigits = 2; // デフォルトは2桁
        
        if (placeholderMatch) {
            placeholder = placeholderMatch[0]; // 例: "###"
            totalDigits = placeholder.length;   // 例: 3
        } else {
            // # が全くない場合、デフォルトとして末尾に "-##" を付けて、2桁の連番とする
            usePattern = usePattern + "-##";
            placeholder = "##";
            totalDigits = 2; 
        }
        
        // パターンから連番を除いた部分が空欄だった場合の処理
        if (usePattern.replace(placeholder, '').trim() === "") {
             usePattern = "image-" + placeholder;
        }


        downloadAllButton.disabled = true;
        downloadAllButton.textContent = `ダウンロード中... (${urls.length}ファイル)`;


        // URLごとにダウンロード処理を実行
        urls.forEach((url, index) => {
            const link = document.createElement('a');
            link.href = url.trim();
            
            let ext = 'png'; 

            // 拡張子を取得
            if (!url.startsWith('data:')) {
                try {
                    const urlPath = new URL(url.trim()).pathname; 
                    const lastSegment = urlPath.substring(urlPath.lastIndexOf('/') + 1);
                    if (lastSegment) {
                        const match = lastSegment.match(/\.([a-z0-9]+)([\?#]|$)/i);
                        if (match) {
                            ext = match[1].toLowerCase();
                            if (ext === 'jpeg') ext = 'jpg';
                        }
                    }
                } catch (e) {
                    // do nothing
                }
            } else {
                // data:URLの場合
                const mimeTypeMatch = url.match(/^data:image\/([^;]+)/);
                ext = mimeTypeMatch ? mimeTypeMatch[1].replace('image/', '').replace('jpeg', 'jpg') : 'png';
            }
            
            // 2. パターンと連番を組み合わせてファイル名を生成
            const sequenceNumberString = getSequenceString(index + 1, totalDigits); 
            
            // プレースホルダーを連番に置き換える (最初のマッチだけ置き換える)
            const baseFilename = usePattern.replace(placeholder, sequenceNumberString);

            const filename = `${baseFilename}.${ext}`;
            
            link.download = filename;
            
            // ダウンロードをトリガー
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // 全てのダウンロードトリガー後にボタンを元に戻す
        setTimeout(() => {
            downloadAllButton.disabled = false;
            downloadAllButton.textContent = 'リストの画像を全てダウンロード';
            alert(`${urls.length} 個のダウンロードを開始しました。`);
        }, 1500); 
    }

    // イベントリスナーの設定
    addButton.addEventListener('click', addImage);
    imageUrlInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            addImage();
        }
    });
    downloadAllButton.addEventListener('click', downloadAllImages);
});
</script>

</body>
</html>