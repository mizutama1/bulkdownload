<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f7f9; }
        .container { max-width: 900px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .input-area { display: flex; margin-bottom: 25px; gap: 10px; }
        #imageUrl { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn-add { padding: 12px 20px; background-color: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        .btn-add:hover { background-color: #229954; }

        /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn-download-all { padding: 15px 30px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 20px; width: 100%; transition: background-color 0.3s; }
        .btn-download-all:hover { background-color: #2980b9; }
        .btn-download-all:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* ç”»åƒãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« (Grid) */
        #imageList { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 10px; 
        }
        .image-item { 
            border: none;
            padding: 0; 
            margin-bottom: 0; 
            position: relative; 
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0; 
            text-align: center; 
            overflow: hidden; 
            border-radius: 4px; 
        }
        
        /* å‰Šé™¤ã‚¢ã‚¤ã‚³ãƒ³ã®CSS */
        .image-item::after {
            content: "Ã—"; 
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.9); 
            color: white;
            font-size: 16px;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 50%; 
            cursor: pointer;
            z-index: 20;
            transition: background 0.2s;
        }
        .image-item:hover::after {
            background: #c0392b;
        }

        /* ç”»åƒã‚’ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .image-preview-container {
            width: 100%;
            height: auto; 
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-bottom: 0; 
            padding: 5px 0; 
        }
        .image-item img { 
            display: block; 
            border: none;
            border-radius: 0;
            width: auto; 
            height: auto; 
            max-width: 95%; 
            object-fit: contain; 
        }
        
        /* ç”»åƒã®ä¸Šã«é‡ã­ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å/ç•ªå·ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .image-info { 
            position: absolute; 
            top: 5px;
            left: 5px;
            padding: 3px 6px;
            background-color: rgba(0, 0, 0, 0.6); 
            color: white; 
            border-radius: 3px;
            z-index: 10; 
            font-size: 12px;
            font-weight: bold;
            max-width: 80%; 
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ç”»åƒä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h1>
    
    <p>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ç”»åƒURLã‚’å…¥åŠ›ã—ç”»åƒã‚’è¿½åŠ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>

    <div class="input-area">
        <input type="text" id="imageUrl" placeholder="ç”»åƒã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: https://...)">
        <button class="btn-add" id="addButton">ç”»åƒã‚’è¿½åŠ </button>
    </div>

    <ul id="imageList">
        </ul>
    
    <button class="btn-download-all" id="downloadAllButton" disabled>ãƒªã‚¹ãƒˆã®ç”»åƒã‚’å…¨ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageUrlInput = document.getElementById('imageUrl');
    const addButton = document.getElementById('addButton');
    const imageList = document.getElementById('imageList');
    const downloadAllButton = document.getElementById('downloadAllButton');
    
    // ğŸ’¡ å‰Šé™¤: const imageCount = document.getElementById('count'); 

    const urls = [];

    // URLã‚’æ­£è¦åŒ–ï¼ˆãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’è£œå®Œï¼‰ã™ã‚‹é–¢æ•°
    function normalizeUrl(inputUrl) {
        let url = inputUrl.trim();
        
        if (url.length < 5) return null; 

        if (url.startsWith('data:')) {
            return url;
        }

        if (url.startsWith('http://') || url.startsWith('https://')) {
            return url;
        } 
        
        if (url.startsWith('//')) {
            return 'https:' + url;
        }
        
        try {
            const testUrl = new URL('https://' + url); 
            return 'https://' + url;
        } catch (e) {
             return null;
        }
    }

    // URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åéƒ¨åˆ†ã‚’æ¨æ¸¬ã™ã‚‹é–¢æ•°
    function getFileName(url) {
        if (url.startsWith('data:')) {
            const mimeTypeMatch = url.match(/^data:image\/([^;]+)/);
            const type = mimeTypeMatch ? mimeTypeMatch[1] : 'ä¸æ˜';
            return `data:å½¢å¼ (${type})`;
        }
        
        try {
            const urlObject = new URL(url);
            const path = urlObject.pathname;
            const filename = path.substring(path.lastIndexOf('/') + 1);
            
            if (filename.length > 0 && filename.includes('.')) {
                return filename;
            } else {
                return urlObject.hostname.replace('www.', '') + '...';
            }
        } catch (e) {
            return `URLãŒç„¡åŠ¹`;
        }
    }

    // URLã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addImage() {
        const rawUrl = imageUrlInput.value;
        const url = normalizeUrl(rawUrl);

        if (!url) {
            alert('æœ‰åŠ¹ãªç”»åƒURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        if (urls.includes(url)) {
            alert('ã“ã®URLã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚');
            return;
        }
        
        urls.push(url);
        renderList();
        imageUrlInput.value = ''; // ä¿®æ­£æ¸ˆã¿
        imageUrlInput.focus();
    }
    
    // ãƒªã‚¹ãƒˆã‚’æç”»ã™ã‚‹é–¢æ•°
    function renderList() {
        imageList.innerHTML = ''; 
        
        urls.forEach((url, index) => {
            const listItem = document.createElement('li');
            listItem.className = 'image-item';
            listItem.setAttribute('data-url', url);

            // Ã—ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰å‰Šé™¤ã‚’å®Ÿè¡Œ
            listItem.onclick = function(e) {
                const rect = listItem.getBoundingClientRect();
                const iconArea = {
                    x1: rect.right - 30,
                    y1: rect.top,
                    x2: rect.right,
                    y2: rect.top + 30
                };
                
                if (e.clientX >= iconArea.x1 && e.clientX <= iconArea.x2 && 
                    e.clientY >= iconArea.y1 && e.clientY <= iconArea.y2) {
                    removeImage(url);
                    e.stopPropagation(); 
                }
            };


            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ
            const previewContainer = document.createElement('div');
            previewContainer.className = 'image-preview-container';

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
            
            // ç”»åƒã®èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®å‡¦ç†
            img.onerror = function() {
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiByeD0iNCIgZmlsbD0iI0REQURERCIvPgo8cGF0aCBkPSJNMTIgMTdMMTcgMTJMMTQgOUw1IDE4TDUgMTdIOC41TDEyIDE3WiIgc3Ryb2tlPSIjNzc3Nzc3IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSI5LjUiIGN5PSI5LjUiIHI9IjEuNSIgZmlsbD0iIzc3Nzc3NyIvPgo8L2F2Zz4='; 
            };
            
            previewContainer.appendChild(img);

            // æƒ…å ± (ç”»åƒã®ä¸Šã«é‡ã­ã‚‹)
            const infoDiv = document.createElement('div');
            infoDiv.className = 'image-info';
            const fileName = getFileName(url);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º
            infoDiv.innerHTML = `<strong>${index + 1}.</strong> ${fileName}`; 

            listItem.appendChild(previewContainer);
            listItem.appendChild(infoDiv); 
            imageList.appendChild(listItem);
        });
        
        // ğŸ’¡ å‰Šé™¤: imageCount.textContent = urls.length;
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        downloadAllButton.disabled = urls.length === 0;
    }

    // URLã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã™ã‚‹é–¢æ•°
    function removeImage(urlToRemove) {
        const index = urls.indexOf(urlToRemove);
        if (index > -1) {
            urls.splice(index, 1);
            renderList();
        }
    }

    /**
     * é€£ç•ªã‚’æŒ‡å®šã•ã‚ŒãŸæ¡æ•°ã§æ–‡å­—åˆ—åŒ–ã™ã‚‹é–¢æ•°
     * @param {number} number é€£ç•ª (1, 2, 3...)
     * @param {number} totalDigits æŒ‡å®šã•ã‚ŒãŸæ¡æ•° (1, 2, 3...)
     * @returns {string} ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸé€£ç•ªæ–‡å­—åˆ—
     */
    function getSequenceString(number, totalDigits) {
        if (totalDigits <= 1) {
            // #ãŒ1ã¤ã€ã¾ãŸã¯ãã‚Œä»¥ä¸‹ã®å ´åˆã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãªã—
            return number.toString();
        }
        
        // 2æ¡ä»¥ä¸Šã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒå¿…è¦ãªå ´åˆ
        return number.toString().padStart(totalDigits, '0');
    }


    // å…¨ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
    function downloadAllImages() {
        if (urls.length === 0) {
            alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç”»åƒãŒãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        
        // 1. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§é€£ç•ªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å–å¾—
        let pattern = prompt("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\né€£ç•ªã‚’å…¥ã‚ŒãŸã„å ´æ‰€ã«ã€Œ#ã€ã‚’æ¡æ•°åˆ†å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "photo-##");

        if (pattern === null) {
            return;
        }
        
        let usePattern = pattern.trim();
        
        // æ­£è¦è¡¨ç¾ã§é€£ç¶šã—ãŸ # ã®å¡Šï¼ˆ#+ï¼‰ã‚’ä¸€ã¤ã ã‘è¦‹ã¤ã‘ã‚‹
        const placeholderMatch = usePattern.match(/(#+)/);
        
        let placeholder = null;
        let totalDigits = 2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯2æ¡
        
        if (placeholderMatch) {
            placeholder = placeholderMatch[0]; // ä¾‹: "###"
            totalDigits = placeholder.length;   // ä¾‹: 3
        } else {
            // # ãŒå…¨ããªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦æœ«å°¾ã« "-##" ã‚’ä»˜ã‘ã¦ã€2æ¡ã®é€£ç•ªã¨ã™ã‚‹
            usePattern = usePattern + "-##";
            placeholder = "##";
            totalDigits = 2; 
        }
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰é€£ç•ªã‚’é™¤ã„ãŸéƒ¨åˆ†ãŒç©ºæ¬„ã ã£ãŸå ´åˆã®å‡¦ç†
        if (usePattern.replace(placeholder, '').trim() === "") {
             usePattern = "image-" + placeholder;
        }


        downloadAllButton.disabled = true;
        downloadAllButton.textContent = `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­... (${urls.length}ãƒ•ã‚¡ã‚¤ãƒ«)`;


        // URLã”ã¨ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚’å®Ÿè¡Œ
        urls.forEach((url, index) => {
            const link = document.createElement('a');
            link.href = url.trim();
            
            let ext = 'png'; 

            // æ‹¡å¼µå­ã‚’å–å¾—
            if (!url.startsWith('data:')) {
                try {
                    const urlPath = new URL(url.trim()).pathname; 
                    const lastSegment = urlPath.substring(urlPath.lastIndexOf('/') + 1);
                    if (lastSegment) {
                        const match = lastSegment.match(/\.([a-z0-9]+)([\?#]|$)/i);
                        if (match) {
                            ext = match[1].toLowerCase();
                            if (ext === 'jpeg') ext = 'jpg';
                        }
                    }
                } catch (e) {
                    // do nothing
                }
            } else {
                // data:URLã®å ´åˆ
                const mimeTypeMatch = url.match(/^data:image\/([^;]+)/);
                ext = mimeTypeMatch ? mimeTypeMatch[1].replace('image/', '').replace('jpeg', 'jpg') : 'png';
            }
            
            // 2. ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨é€£ç•ªã‚’çµ„ã¿åˆã‚ã›ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
            const sequenceNumberString = getSequenceString(index + 1, totalDigits); 
            
            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’é€£ç•ªã«ç½®ãæ›ãˆã‚‹ (æœ€åˆã®ãƒãƒƒãƒã ã‘ç½®ãæ›ãˆã‚‹)
            const baseFilename = usePattern.replace(placeholder, sequenceNumberString);

            const filename = `${baseFilename}.${ext}`;
            
            link.download = filename;
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ãƒˆãƒªã‚¬ãƒ¼
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // å…¨ã¦ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒˆãƒªã‚¬ãƒ¼å¾Œã«ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        setTimeout(() => {
            downloadAllButton.disabled = false;
            downloadAllButton.textContent = 'ãƒªã‚¹ãƒˆã®ç”»åƒã‚’å…¨ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            alert(`${urls.length} å€‹ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚`);
        }, 1500); 
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    addButton.addEventListener('click', addImage);
    imageUrlInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Enterã‚­ãƒ¼ã«ã‚ˆã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€ä¿¡ã‚’é˜²ã
            addImage();
        }
    });
    downloadAllButton.addEventListener('click', downloadAllImages);
});
</script>

</body>
</html>
